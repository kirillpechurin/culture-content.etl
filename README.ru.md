# Culture Content | ETL

[![ru](https://img.shields.io/badge/lang-ru-green.svg)](README.ru.md)
[![en](https://img.shields.io/badge/lang-en-red.svg)](README.md)
___

1. [Цель проекта](#цель-проекта)
2. [Реализация](#реализация)
    + [Техническая часть](#техническая-часть)
    + [Бизнес-задачи](#бизнес-задачи)
3. [Структура проекта](#структура-проекта)
4. [Описание переменных окружения](#описание-переменных-окружения)
5. [Запуск](#запуск)
    + [Зависимости](#зависимости)
    + [Локальный запуск](#локальный-запуск)
6. [Дизайн системы](#дизайн-системы)
7. [Лицензия](#лицензия)

___

## Цель проекта

Один из сервисов проекта "Culture Content", 
реализующий ETL механизм для переноса данных о книгах в связанные источники:
- RabbitMQ - для подписок на изменения.
- Elasticsearch - для поисковой системы.

## Реализация

___

### Техническая часть

* Сервис реализован с использованием ETL механизма, базирующегося на [Celery](https://docs.celeryq.dev/en/stable/).
* Для извлечения данных используется подключения ко внешней PostgreSQL БД.
* Преобразования данных происходят средствами языка программирования.
* Занесение данных в Elasticsearch для поисковой системы и в RabbitMQ для дальнейшей обработки по подпискам.
* Для сохранения состояния ETL механизма используется Redis.

### Бизнес-задачи

* Перенос данных о книгах в поисковую систему.
* Обработка данных о книгах для реагирования на подписки. Подписка может быть трех видов:
  * На книгу.
  * На автора.
  * На жанр.
* При появлении новых данных по подписке подразумевается соответствующее уведомление пользователю.

## Структура проекта

___

- `app` - сервис
  - `conf` - конфигурация сервиса, celery и внешних БД.
  - `internal` - бизнес-логика.
    - `bootstrap` - пакет подготовки сервиса.
    - `etl` - реализация ETL.
    - `integrations` - Интеграция с внешними серверами.
    - `utils` - общие утилиты сервиса.
    - `tasks.py` - celery-задачи сервиса, в том числе ETL.
  - `.env.example` - Пример переменных окружения.
  - `main.py` - Точка запуска ETL.
  - `requirements.txt` - Зависимости сервиса.
- `docs` - документация.

## Описание переменных окружения

___

* `BOOKS_ETL_READER_BATCH_SIZE` - Размер пакета единоразового чтения данных.
* `BOOKS_ETL_READER_TIMEOUT_BY_EMPTY` - Время "сна" для ETL в случае отсутствия данных.
* `BOOKS_ETL_DB_STATE_KEY` - Ключ для сохранения состояния ETL.

* `KVDB_HOST` - Хост, на котором запущен сервер базы данных вида "ключ-значение".
* `KVDB_PORT` - Порт, на котором запущен сервер базы данных вида "ключ-значение".
* `KVDB_USERNAME` - Пользователь сервера базы данных вида "ключ-значение".
* `KVDB_PASSWORD` - Пароль для пользователя сервера базы данных вида "ключ-значение".

* `EXTERNAL_AMQP_HOST` - Хост, на котором запущен внешний сервер AMQP.
* `EXTERNAL_AMQP_PORT` - Порт, на котором запущен внешний сервер AMQP.
* `EXTERNAL_AMQP_USER` - Пользователь внешнего сервера AMQP.
* `EXTERNAL_AMQP_PASSWORD` - Пароль для пользователя внешнего сервера AMQP.

* `EXTERNAL_PG_HOST` - Хост, на котором запущен внешний сервер базы данных PostgreSQL.
* `EXTERNAL_PG_PORT` - Порт, на котором запущен внешний сервер базы данных PostgreSQL
* `EXTERNAL_PG_DB_NAME` - Имя базы данных с внешнего сервера базы данных PostgreSQL.
* `EXTERNAL_PG_USER` - Пользователь внешнего сервера базы данных PostgreSQL.
* `EXTERNAL_PG_PASSWORD` - Пароль для пользователя внешнего сервера базы данных PostgreSQL.

* `EXTERNAL_ELASTICSEARCH_SCHEME` - Схема подключения к внешнему серверу Elasticsearch (http/https).
* `EXTERNAL_ELASTICSEARCH_HOST` - Хост, на котором запущен внешний сервер Elasticsearch.
* `EXTERNAL_ELASTICSEARCH_PORT` - Порт, на котором запущен внешний сервер Elasticsearch.

* `CELERY_BROKER_URL` - URL подключения к брокеру сообщений.
* `CELERY_RESULT_BACKEND` - URL для сохранения результатов задач.
* `CELERY_BROKER_CONNECTION_RETRY_ON_STARTUP` - Требуется ли повторно пытаться подключиться при запуске.
* `CELERY_RESULT_EXPIRES_MINUTES` - Значение в минутах, согласно которому результаты задач будут удалены.
* `CELERY_TASK_ALWAYS_EAGER` - Запуск задач без асинхронного вызова (Для тестирования).

## Запуск

___

### Зависимости

* Установленная версия Python `3.10` или выше.

### Локальный запуск

1. Создайте базу данных PostgreSQL для использования и выполните скрипт [create_table.sql](docs/db/postgresql/create_table.sql).
2. Создайте `src/.env` файл и укажите в нем переменные окружения по примеру `src/.env.example`.
3. Запустите `python3 --version` и убедитесь, что у вас есть версия python `3.10` или выше.
4. `python3 -m venv venv` - Создание виртуального окружения python в папке venv.
5. `source venv/bin/activate` - Активируйте виртуальное окружение.
6. `pip3 install -r requirements.txt` - Установка зависимостей.
7. `cd app` - Перейдите в `app`.
8. Вы уже готовы начать! Запустите ETL:


- Запуск Loaders
  ```shell
  celery --app=conf worker -E -Ofair --loglevel=info --queues=loaders --concurrency=1 --hostname=loaders
  ```

- Запуск Transformers
  ```shell
  celery --app=conf worker -E -Ofair --loglevel=info --queues=transformers --concurrency=1 --hostname=transformers
  ```

- Запуск Readers
  ```shell
  python main.py
  ```

## Дизайн системы

- [Общий дизайн и будущее системы](docs/design/common.png)
- [Дизайн сервиса](docs/design/current.png)

## Лицензия

___
См. [LICENSE](LICENSE)